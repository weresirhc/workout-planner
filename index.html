<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Planner â€” Sets, 1RM, Volume</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: #0f172a; color: #e5e7eb; margin: 0; padding: 16px; }
    h1 { font-size: 1.8em; margin: 0 0 8px; }
    .muted { color:#94a3b8; }
    .stack { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .exercise { margin-top: 16px; border: 1px solid #334155; border-radius: 8px; padding: 12px; background: #1e293b; }
    .exercise h2 { margin: 0 0 8px; font-size: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    th, td { padding: 8px; border-bottom: 1px solid #334155; }
    th { text-align: left; background: #111827; color:#94a3b8; font-size:12px; text-transform:uppercase; letter-spacing:.02em; }
    input { width: 90px; padding: 6px 8px; background: #111827; border: 1px solid #334155; color: #e5e7eb; border-radius: 8px; }
    input:focus { border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.18); outline: none; }
    .wide { width: 220px; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #334155; background: #111827; color: #e5e7eb; cursor: pointer; font-weight:600; }
    button:hover { border-color: #60a5fa; }
    .danger { border-color:#7f1d1d; }
    .chart { margin-top: 24px; }
    .actions { white-space: nowrap; }
    .btn-sm { padding: 4px 6px; border-radius: 6px; font-size: 12px; }
    .spark { margin-top:6px; }
    .diag { display:none; font-size:12px; color:#94a3b8; margin-top:8px; }
      .actions { white-space: nowrap; }
    .btn-sm { padding: 4px 6px; border-radius: 6px; font-size: 12px; }
    .spark { margin-top:6px; }
    .diag { display:none; font-size:12px; color:#94a3b8; margin-top:8px; }
    /* NEW: mobile-friendly table wrapper so header/background spans all columns */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    /* ensure the internal table has enough width to show all columns including Actions */
    .exercise table { min-width: 820px; }
      /* Floating action buttons */
    .fab-wrap { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 12px; z-index: 50; }
    .fab { width: 56px; height: 56px; border-radius: 9999px; border: none; background: #2563eb; color: #fff; font-weight: 800; font-size: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); cursor: pointer; }
    .fab.secondary { background: #10b981; }
    .fab:active { transform: translateY(1px); }
  </style>
</head>
<body>
  <h1>Workout Planner</h1>
  <div class="stack" style="margin:8px 0 12px">
    <button id="addExercise">+ Add exercise</button>
    <button id="undoBtn">Undo last</button>
    <span class="muted">Total Workout Volume: <strong id="totalVol">0</strong></span>
  </div>

  <div id="exercises"></div>

  <div class="chart" id="chart"></div>
  <div id="diag" class="diag"></div>

  <!-- Floating Action Buttons -->
  <div class="fab-wrap">
    <button id="fabAddSet" class="fab secondary" title="Add set" aria-label="Add set">+S</button>
    <button id="fabAddExercise" class="fab" title="Add exercise" aria-label="Add exercise">+E</button>
  </div>

<script>
// ------- Helpers & formulas -------
const LB_PER_KG = 2.2046226218;
const KG_PER_LB = 1 / LB_PER_KG; // 0.45359237
const toKg = lb => lb * KG_PER_LB;
const toLb = kg => kg * LB_PER_KG;

function epley(w, r) { return w * (1 + r / 30); }
function brzycki(w, r) { return w * (36 / (37 - r)); }
function lander(w, r) { return w / (1.013 - 0.0267123 * r); }

// ------- State & undo -------
const exercisesDiv = document.getElementById('exercises');
const chartDiv = d3.select('#chart');
const undoStack = [];
let isRestoring = false;

function readPlan(){
  const plan = [];
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const nameEl = exDiv.querySelector('h2');
    const name = nameEl ? nameEl.textContent.trim() : '';
    const sets = [];
    exDiv.querySelectorAll('tbody tr').forEach(tr => {
      const wEl = tr.querySelector('.wlb');
      const rEl = tr.querySelector('.r');
      const w = wEl ? parseFloat(wEl.value) || 0 : 0;
      const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
      sets.push({ w, r });
    });
    plan.push({ name, sets });
  });
  return plan;
}

function writePlan(plan){
  isRestoring = true;
  exercisesDiv.innerHTML = '';
  (plan || []).forEach(ex => {
    addExercise(ex.name || 'Exercise');
    const last = exercisesDiv.lastElementChild;
    const tbody = last.querySelector('tbody');
    tbody.innerHTML = '';
    (ex.sets || []).forEach(s => addSet(tbody, s.w, s.r));
  });
  isRestoring = false;
  update();
}

function pushHistory(){
  if (isRestoring) return;
  try {
    undoStack.push(JSON.stringify(readPlan()));
    if (undoStack.length > 50) undoStack.shift();
  } catch(e) { /* ignore */ }
}

function undoLast(){
  if (!undoStack.length) return;
  const raw = undoStack.pop();
  try { writePlan(JSON.parse(raw)); } catch(e) { /* ignore */ }
}

document.getElementById('addExercise').addEventListener('click', () => addExercise());
document.getElementById('undoBtn').addEventListener('click', undoLast);

// Floating action buttons logic
function quickAddExercise(){ addExercise(); }
function quickAddSet(){
  let last = exercisesDiv.querySelector('.exercise:last-of-type');
  if (!last) { addExercise(); last = exercisesDiv.querySelector('.exercise:last-of-type'); }
  const tbody = last.querySelector('tbody');
  addSet(tbody);
  const newRow = tbody.lastElementChild;
  if (newRow) {
    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const wlb = newRow.querySelector('.wlb');
    if (wlb) { wlb.focus(); if (wlb.select) wlb.select(); }
  }
}
const fabEx = document.getElementById('fabAddExercise');
if (fabEx) fabEx.addEventListener('click', quickAddExercise);
const fabSet = document.getElementById('fabAddSet');
if (fabSet) fabSet.addEventListener('click', quickAddSet);

// ------- UI builders -------
function addExercise(name='New Exercise') {
  pushHistory();
  const exDiv = document.createElement('div');
  exDiv.className = 'exercise';
  exDiv.innerHTML = `
    <h2 contenteditable="true" tabindex="0">${name}</h2>
    <div class="table-wrap"><table>
      <thead>
        <tr>
          <th>Set</th>
          <th>Weight (lb)</th>
          <th>Weight (kg)</th>
          <th>Reps</th>
          <th>Epley 1RM</th>
          <th>Brzycki 1RM</th>
          <th>Lander 1RM</th>
          <th>Volume</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table></div>
    <div class="muted">Exercise Volume: <strong class="exTotal">0</strong></div>
    <div class="spark"></div>
    <div class="stack" style="margin-top:8px">
      <button class="addSet" type="button">Add Set</button>
      <button class="danger removeEx" type="button">Delete Exercise</button>
    </div>`;
  exercisesDiv.appendChild(exDiv);

  // scroll to and focus the new exercise title (mobile-friendly)
  const titleEl = exDiv.querySelector('h2');
  if (titleEl) {
    exDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    titleEl.focus();
    try {
      const sel = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(titleEl);
      sel.removeAllRanges();
      sel.addRange(range);
    } catch (e) {}
  }

  const tbody = exDiv.querySelector('tbody');
  exDiv.querySelector('.addSet').addEventListener('click', () => addSet(tbody));
  exDiv.querySelector('.removeEx').addEventListener('click', () => { pushHistory(); exDiv.remove(); update(); });
  addSet(tbody);
}

function addSet(tbody, w=0, r=1) {
  const tr = document.createElement('tr');
  const setNum = tbody.children.length + 1;
  pushHistory();
  tr.innerHTML = `
    <td class="setno">${setNum}</td>
    <td><input type="number" step="0.5" value="${w}" class="wlb"></td>
    <td><input type="number" step="0.5" value="${toKg(w).toFixed(1)}" class="wkg"></td>
    <td><input type="number" value="${r}" class="r"></td>
    <td class="epley"></td>
    <td class="brzycki"></td>
    <td class="lander"></td>
    <td class="vol"></td>
    <td class="actions">
      <button class="btn-sm dup" type="button">+ Set</button>
      <button class="btn-sm danger del" type="button">ðŸ—‘</button>
    </td>`;
  tbody.appendChild(tr);

  // inputs
  tr.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('input', update);
    // snapshot when first focused
    inp.addEventListener('focus', function onf(){ pushHistory(); inp.removeEventListener('focus', onf); });
  });

  // wire actions
  wireRowActions(tr, tbody);

  // lb <-> kg conversion
  const lb = tr.querySelector('.wlb');
  const kg = tr.querySelector('.wkg');
  if (lb && kg){
    lb.addEventListener('input', () => {
      const v = parseFloat(lb.value);
      if (!Number.isNaN(v)) kg.value = toKg(v).toFixed(1);
      update();
    });
    kg.addEventListener('input', () => {
      const v = parseFloat(kg.value);
      if (!Number.isNaN(v)) lb.value = toLb(v).toFixed(1);
      update();
    });
  }

  update();
}

function wireRowActions(tr, tbody){
  const lb = tr.querySelector('.wlb');
  const rInput = tr.querySelector('.r');
  const dupBtn = tr.querySelector('.dup');
  const delBtn = tr.querySelector('.del');
  if (dupBtn) dupBtn.addEventListener('click', () => {
    pushHistory();
    const w = lb ? parseFloat(lb.value) || 0 : 0;
    const r = rInput ? Math.max(1, parseInt(rInput.value) || 0) : 1;
    addSet(tbody, w, r);
    // move the new row under the current one
    const newRow = tbody.lastElementChild;
    tbody.insertBefore(newRow, tr.nextElementSibling);
    update();
  });
  if (delBtn) delBtn.addEventListener('click', () => { pushHistory(); tr.remove(); update(); });
}

// ------- Update & charts -------
function update() {
  const points = [];
  let totalVolume = 0;
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const nameEl = exDiv.querySelector('h2');
    const name = nameEl ? nameEl.textContent.trim() : '';
    let exerciseVolume = 0;
    exDiv.querySelectorAll('tbody tr').forEach((tr, i) => {
      // set #'s
      const no = tr.querySelector('.setno');
      if (no) no.textContent = i+1;
      const wEl = tr.querySelector('.wlb');
      const rEl = tr.querySelector('.r');
      const w = wEl ? parseFloat(wEl.value) || 0 : 0; // pounds
      const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
      const e = epley(w, r);
      const b = brzycki(w, r);
      const l = lander(w, r);
      const vol = w * r; // pounds moved in this set
      const eEl = tr.querySelector('.epley'); if (eEl) eEl.textContent = e ? e.toFixed(1) : '';
      const bEl = tr.querySelector('.brzycki'); if (bEl) bEl.textContent = b ? b.toFixed(1) : '';
      const lEl = tr.querySelector('.lander'); if (lEl) lEl.textContent = l ? l.toFixed(1) : '';
      const vEl = tr.querySelector('.vol'); if (vEl) vEl.textContent = vol ? vol.toFixed(1) : '';

      exerciseVolume += vol;
      totalVolume += vol;
      const label = name ? `${name} (Set ${i+1})` : `Set ${i+1}`;
      points.push({ label, cumulative: totalVolume, added: vol });
    });
    const exT = exDiv.querySelector('.exTotal');
    if (exT) exT.textContent = exerciseVolume.toFixed(1);
    drawSpark(exDiv);
  });
  const tv = document.getElementById('totalVol');
  if (tv) tv.textContent = totalVolume.toFixed(1);
  drawRolling(points);
}

function drawRolling(points) {
  chartDiv.selectAll('*').remove();
  if (!points.length) return;

  const width = Math.min(900, window.innerWidth - 32);
  const height = 420;
  const margin = {top: 20, right: 24, bottom: 72, left: 64};
  const svg = chartDiv.append('svg').attr('width', width).attr('height', height);

  const x = d3.scalePoint()
    .domain(points.map(d => d.label))
    .range([margin.left, width - margin.right])
    .padding(0.5);

  const y = d3.scaleLinear()
    .domain([0, d3.max(points, d => d.cumulative) * 1.1]).nice()
    .range([height - margin.bottom, margin.top]);

  // gridlines
  svg.append('g')
    .attr('stroke', '#334155')
    .attr('stroke-opacity', 0.5)
    .selectAll('line')
    .data(y.ticks())
    .join('line')
    .attr('x1', margin.left)
    .attr('x2', width - margin.right)
    .attr('y1', d => y(d))
    .attr('y2', d => y(d));

  // line
  const line = d3.line()
    .x(d => x(d.label))
    .y(d => y(d.cumulative))
    .curve(d3.curveMonotoneX);

  svg.append('path')
    .attr('fill', 'none')
    .attr('stroke', '#60a5fa')
    .attr('stroke-width', 2.5)
    .attr('d', line(points));

  // points and value labels
  const fmt = d3.format('.0f');
  svg.append('g')
    .selectAll('circle')
    .data(points)
    .join('circle')
    .attr('cx', d => x(d.label))
    .attr('cy', d => y(d.cumulative))
    .attr('r', 3.5)
    .attr('fill', '#60a5fa');

  svg.append('g')
    .selectAll('text.pt')
    .data(points)
    .join('text')
    .attr('class', 'pt')
    .attr('x', d => x(d.label))
    .attr('y', d => y(d.cumulative) - 8)
    .attr('text-anchor', 'middle')
    .attr('font-size', 11)
    .attr('fill', '#e5e7eb')
    .text(d => fmt(d.cumulative));

  // axes
  svg.append('g')
    .attr('transform', `translate(0,${height - margin.bottom})`)
    .call(d3.axisBottom(x))
    .selectAll('text')
    .attr('transform','rotate(-32)')
    .style('text-anchor','end');

  svg.append('g')
    .attr('transform', `translate(${margin.left},0)`) 
    .call(d3.axisLeft(y))
    .append('text')
    .attr('x', -margin.left + 8)
    .attr('y', margin.top - 8)
    .attr('fill', '#e5e7eb')
    .attr('font-size', 12)
    .text('Rolling total (lb)');
}

function drawSpark(exDiv){
  const host = d3.select(exDiv).select('.spark');
  host.selectAll('*').remove();
  const rows = exDiv.querySelectorAll('tbody tr');
  if(!rows.length) return;
  const pts=[]; let cum=0;
  rows.forEach(tr=>{
    const wEl = tr.querySelector('.wlb');
    const rEl = tr.querySelector('.r');
    const w = wEl ? parseFloat(wEl.value) || 0 : 0;
    const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
    cum += w*r;
    pts.push(cum);
  });
  const w = 240, h = 60, m = {top:4,right:6,bottom:4,left:6};
  const svg = host.append('svg').attr('width', w).attr('height', h);
  const x = d3.scaleLinear().domain([1, pts.length]).range([m.left, w - m.right]);
  const y = d3.scaleLinear().domain([0, d3.max(pts)]).nice().range([h - m.bottom, m.top]);
  const line = d3.line().x((d,i)=>x(i+1)).y(d=>y(d)).curve(d3.curveMonotoneX);
  svg.append('path').attr('fill','none').attr('stroke','#34d399').attr('stroke-width',2).attr('d', line(pts));
}

// ------- Diagnostics (simple tests) -------
(function selfTest(){
  try {
    const almostEq = (a,b,eps=1e-6) => Math.abs(a-b) < eps;
    console.assert(almostEq(toLb(100*KG_PER_LB), 100), 'toLb âˆ˜ toKg roundtrip failed');
    console.assert(almostEq(toKg(100*LB_PER_KG), 100), 'toKg âˆ˜ toLb roundtrip failed');
    // sample: 225 x 10 â†’ Epley=300, Brzycki=300, Landerâ‰ˆ301.8
    const w=225, r=10;
    console.assert(almostEq(epley(w,r), 300), 'Epley check failed');
    console.assert(almostEq(brzycki(w,r), 300), 'Brzycki check failed');
    const l = lander(w,r);
    console.assert(l > 301 && l < 302.5, 'Lander range check failed');
    document.getElementById('diag').textContent = 'Diagnostics passed';
  } catch(e) {
    const d = document.getElementById('diag');
    d.style.display='block';
    d.textContent = 'Diagnostics error: ' + e.message;
  }
})();

// seed example
addExercise('Bench Press');

</script>
</body>
</html>


