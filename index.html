<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Planner â€” Sets, 1RM, Volume</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: #0f172a; color: #e5e7eb; margin: 0; padding: 16px; }
    h1 { font-size: 1.8em; margin: 0 0 8px; }
    .muted { color:#94a3b8; }
    .stack { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .exercise { margin-top: 16px; border: 1px solid #334155; border-radius: 8px; padding: 12px; background: #1e293b; }
    .exercise h2 { margin: 0 0 8px; font-size: 1.2em; }
    table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    th, td { padding: 8px; border-bottom: 1px solid #334155; }
    th { text-align: left; background: #111827; color:#94a3b8; font-size:12px; text-transform:uppercase; letter-spacing:.02em; }
    input { width: 90px; padding: 6px 8px; background: #111827; border: 1px solid #334155; color: #e5e7eb; border-radius: 8px; }
    input:focus { border-color:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.18); outline: none; }
    .chart { margin-top: 24px; }
    .actions { white-space: nowrap; }
    .btn-sm { padding: 4px 6px; border-radius: 6px; font-size: 12px; }
    .spark { margin-top:6px; }
    .diag { display:none; font-size:12px; color:#94a3b8; margin-top:8px; }
    /* mobile-friendly table wrapper so header/background spans all columns */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    /* ensure the internal table has enough width to show all columns including Actions */
    .exercise table { min-width: 820px; }
    /* Floating action buttons */
    .fab-wrap { position: fixed; right: 16px; bottom: 16px; display: flex; flex-direction: column; gap: 12px; z-index: 50; }
    .fab { width: 56px; height: 56px; border-radius: 9999px; border: none; background: #2563eb; color: #fff; font-weight: 800; font-size: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); cursor: pointer; }
    .fab.secondary { background: #10b981; }
    .fab:active { transform: translateY(1px); }
    /* Modal for CSV/XLSX load options */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal .panel { background: #111827; border: 1px solid #334155; border-radius: 12px; width: min(92vw, 420px); padding: 16px; }
    .modal .panel h3 { margin: 0 0 8px; }
    .modal .panel p { margin: 0 0 12px; color: #94a3b8; }
    .modal .actions-row { display:flex; gap:8px; justify-content:flex-end; }
  </style>
</head>
<body>
  <h1>Workout Planner</h1>
  <div class="stack" style="margin:8px 0 12px">
    <button id="addExercise">+ Add exercise</button>
    <button id="undoBtn">Undo last</button>
    <button id="saveCsv">Save CSV</button>
    <button id="loadCsv">Load CSV/XLSX</button>
    <span class="muted">Total Workout Volume: <strong id="totalVol">0</strong></span>
  </div>

  <div id="exercises"></div>

  <div class="chart" id="chart"></div>
  <div id="diag" class="diag"></div>

  <!-- Hidden input + modal for load options -->
  <input id="loadFileInput" type="file" accept=".csv,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx" style="display:none" />
  <div id="loadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loadTitle">
    <div class="panel">
      <h3 id="loadTitle">Open File</h3>
      <p>Choose where to open your saved data.</p>
      <div class="actions-row">
        <button id="importHereBtn">Import here</button>
        <button id="openSheetsBtn">Open in Google Sheets</button>
        <button id="cancelLoadBtn" class="danger">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Floating Action Buttons -->
  <div class="fab-wrap">
    <button id="fabAddSet" class="fab secondary" title="Add set" aria-label="Add set">+S</button>
    <button id="fabAddExercise" class="fab" title="Add exercise" aria-label="Add exercise">+E</button>
  </div>

<script>
// ================= Helpers & formulas =================
const LB_PER_KG = 2.2046226218;
const KG_PER_LB = 1 / LB_PER_KG; // 0.45359237
const toKg = lb => lb * KG_PER_LB;
const toLb = kg => kg * LB_PER_KG;

function epley(w, r) { return w * (1 + r / 30); }
function brzycki(w, r) { return w * (36 / (37 - r)); }
function lander(w, r) { return w / (1.013 - 0.0267123 * r); }

// ================= State & undo =================
const exercisesDiv = document.getElementById('exercises');
const chartDiv = d3.select('#chart');
const undoStack = [];
let isRestoring = false;

function readPlan(){
  const plan = [];
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const nameEl = exDiv.querySelector('h2');
    const name = nameEl ? nameEl.textContent.trim() : '';
    const sets = [];
    exDiv.querySelectorAll('tbody tr').forEach(tr => {
      const wEl = tr.querySelector('.wlb');
      const rEl = tr.querySelector('.r');
      const w = wEl ? parseFloat(wEl.value) || 0 : 0;
      const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
      sets.push({ w, r });
    });
    plan.push({ name, sets });
  });
  return plan;
}

function writePlan(plan){
  isRestoring = true;
  exercisesDiv.innerHTML = '';
  (plan || []).forEach(ex => {
    addExercise(ex.name || 'Exercise');
    const last = exercisesDiv.lastElementChild;
    const tbody = last.querySelector('tbody');
    tbody.innerHTML = '';
    (ex.sets || []).forEach(s => addSet(tbody, s.w, s.r));
  });
  isRestoring = false;
  update();
}

function pushHistory(){
  if (isRestoring) return;
  try {
    undoStack.push(JSON.stringify(readPlan()));
    if (undoStack.length > 50) undoStack.shift();
  } catch(e) { /* ignore */ }
}

function undoLast(){
  if (!undoStack.length) return;
  const raw = undoStack.pop();
  try { writePlan(JSON.parse(raw)); } catch(e) { /* ignore */ }
}

// Top controls
const addExBtn = document.getElementById('addExercise');
const undoBtn = document.getElementById('undoBtn');
addExBtn.addEventListener('click', () => addExercise());
undoBtn.addEventListener('click', undoLast);

// Floating action buttons
function quickAddExercise(){ addExercise(); }
function quickAddSet(){
  let last = exercisesDiv.querySelector('.exercise:last-of-type');
  if (!last) { addExercise(); last = exercisesDiv.querySelector('.exercise:last-of-type'); }
  const tbody = last.querySelector('tbody');
  addSet(tbody);
  const newRow = tbody.lastElementChild;
  if (newRow) {
    newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
    const wlb = newRow.querySelector('.wlb');
    if (wlb) { wlb.focus(); if (wlb.select) wlb.select(); }
  }
}
const fabEx = document.getElementById('fabAddExercise');
const fabSet = document.getElementById('fabAddSet');
fabEx.addEventListener('click', quickAddExercise);
fabSet.addEventListener('click', quickAddSet);

// ================= UI builders =================
function addExercise(name='New Exercise') {
  pushHistory();
  const exDiv = document.createElement('div');
  exDiv.className = 'exercise';
  exDiv.innerHTML = `
    <h2 contenteditable="true" tabindex="0">${name}</h2>
    <div class="table-wrap"><table>
      <thead>
        <tr>
          <th>Set</th>
          <th>Weight (lb)</th>
          <th>Weight (kg)</th>
          <th>Reps</th>
          <th>Epley 1RM</th>
          <th>Brzycki 1RM</th>
          <th>Lander 1RM</th>
          <th>Volume</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table></div>
    <div class="muted">Exercise Volume: <strong class="exTotal">0</strong></div>
    <div class="spark"></div>
    <div class="stack" style="margin-top:8px">
      <button class="addSet" type="button">Add Set</button>
      <button class="danger removeEx" type="button">Delete Exercise</button>
    </div>`;
  exercisesDiv.appendChild(exDiv);

  // scroll to and focus the new exercise title (mobile-friendly)
  const titleEl = exDiv.querySelector('h2');
  if (titleEl) {
    exDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    titleEl.focus();
    try {
      const sel = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(titleEl);
      sel.removeAllRanges();
      sel.addRange(range);
    } catch (e) {}
  }

  const tbody = exDiv.querySelector('tbody');
  exDiv.querySelector('.addSet').addEventListener('click', () => addSet(tbody));
  exDiv.querySelector('.removeEx').addEventListener('click', () => { pushHistory(); exDiv.remove(); update(); });
  addSet(tbody);
}

function addSet(tbody, w=0, r=1) {
  const tr = document.createElement('tr');
  const setNum = tbody.children.length + 1;
  pushHistory();
  tr.innerHTML = `
    <td class="setno">${setNum}</td>
    <td><input type="number" step="0.5" value="${w}" class="wlb"></td>
    <td><input type="number" step="0.5" value="${toKg(w).toFixed(1)}" class="wkg"></td>
    <td><input type="number" value="${r}" class="r"></td>
    <td class="epley"></td>
    <td class="brzycki"></td>
    <td class="lander"></td>
    <td class="vol"></td>
    <td class="actions">
      <button class="btn-sm dup" type="button">+ Set</button>
      <button class="btn-sm danger del" type="button">ðŸ—‘</button>
    </td>`;
  tbody.appendChild(tr);

  // inputs
  tr.querySelectorAll('input').forEach(inp => {
    inp.addEventListener('input', update);
    // snapshot when first focused
    inp.addEventListener('focus', function onf(){ pushHistory(); inp.removeEventListener('focus', onf); });
  });

  // wire actions
  wireRowActions(tr, tbody);

  // lb <-> kg conversion
  const lb = tr.querySelector('.wlb');
  const kg = tr.querySelector('.wkg');
  if (lb && kg){
    lb.addEventListener('input', () => {
      const v = parseFloat(lb.value);
      if (!Number.isNaN(v)) kg.value = toKg(v).toFixed(1);
      update();
    });
    kg.addEventListener('input', () => {
      const v = parseFloat(kg.value);
      if (!Number.isNaN(v)) lb.value = toLb(v).toFixed(1);
      update();
    });
  }

  update();
}

function wireRowActions(tr, tbody){
  const lb = tr.querySelector('.wlb');
  const rInput = tr.querySelector('.r');
  const dupBtn = tr.querySelector('.dup');
  const delBtn = tr.querySelector('.del');
  if (dupBtn) dupBtn.addEventListener('click', () => {
    pushHistory();
    const w = lb ? parseFloat(lb.value) || 0 : 0;
    const r = rInput ? Math.max(1, parseInt(rInput.value) || 0) : 1;
    addSet(tbody, w, r);
    // move the new row under the current one
    const newRow = tbody.lastElementChild;
    tbody.insertBefore(newRow, tr.nextElementSibling);
    update();
  });
  if (delBtn) delBtn.addEventListener('click', () => { pushHistory(); tr.remove(); update(); });
}

// ================= Update & charts =================
function update() {
  const points = [];
  let totalVolume = 0;
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const nameEl = exDiv.querySelector('h2');
    const name = nameEl ? nameEl.textContent.trim() : '';
    let exerciseVolume = 0;
    exDiv.querySelectorAll('tbody tr').forEach((tr, i) => {
      // set #'s
      const no = tr.querySelector('.setno');
      if (no) no.textContent = i+1;
      const wEl = tr.querySelector('.wlb');
      const rEl = tr.querySelector('.r');
      const w = wEl ? parseFloat(wEl.value) || 0 : 0; // pounds
      const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
      const e = epley(w, r);
      const b = brzycki(w, r);
      const l = lander(w, r);
      const vol = w * r; // pounds moved in this set
      const eEl = tr.querySelector('.epley'); if (eEl) eEl.textContent = e ? e.toFixed(1) : '';
      const bEl = tr.querySelector('.brzycki'); if (bEl) bEl.textContent = b ? b.toFixed(1) : '';
      const lEl = tr.querySelector('.lander'); if (lEl) lEl.textContent = l ? l.toFixed(1) : '';
      const vEl = tr.querySelector('.vol'); if (vEl) vEl.textContent = vol ? vol.toFixed(1) : '';

      exerciseVolume += vol;
      totalVolume += vol;
      const label = name ? `${name} (Set ${i+1})` : `Set ${i+1}`;
      points.push({ label, cumulative: totalVolume, added: vol });
    });
    const exT = exDiv.querySelector('.exTotal');
    if (exT) exT.textContent = exerciseVolume.toFixed(1);
    drawSpark(exDiv);
  });
  const tv = document.getElementById('totalVol');
  if (tv) tv.textContent = totalVolume.toFixed(1);
  drawRolling(points);
}

function drawRolling(points) {
  chartDiv.selectAll('*').remove();
  if (!points.length) return;

  const width = Math.min(900, window.innerWidth - 32);
  const height = 420;
  const margin = {top: 20, right: 24, bottom: 72, left: 64};
  const svg = chartDiv.append('svg').attr('width', width).attr('height', height);

  const x = d3.scalePoint()
    .domain(points.map(d => d.label))
    .range([margin.left, width - margin.right])
    .padding(0.5);

  const y = d3.scaleLinear()
    .domain([0, d3.max(points, d => d.cumulative) * 1.1]).nice()
    .range([height - margin.bottom, margin.top]);

  // gridlines
  svg.append('g')
    .attr('stroke', '#334155')
    .attr('stroke-opacity', 0.5)
    .selectAll('line')
    .data(y.ticks())
    .join('line')
    .attr('x1', margin.left)
    .attr('x2', width - margin.right)
    .attr('y1', d => y(d))
    .attr('y2', d => y(d));

  // line
  const line = d3.line()
    .x(d => x(d.label))
    .y(d => y(d.cumulative))
    .curve(d3.curveMonotoneX);

  svg.append('path')
    .attr('fill', 'none')
    .attr('stroke', '#60a5fa')
    .attr('stroke-width', 2.5)
    .attr('d', line(points));

  // points and value labels
  const fmt = d3.format('.0f');
  svg.append('g')
    .selectAll('circle')
    .data(points)
    .join('circle')
    .attr('cx', d => x(d.label))
    .attr('cy', d => y(d.cumulative))
    .attr('r', 3.5)
    .attr('fill', '#60a5fa');

  svg.append('g')
    .selectAll('text.pt')
    .data(points)
    .join('text')
    .attr('class', 'pt')
    .attr('x', d => x(d.label))
    .attr('y', d => y(d.cumulative) - 8)
    .attr('text-anchor', 'middle')
    .attr('font-size', 11)
    .attr('fill', '#e5e7eb')
    .text(d => fmt(d.cumulative));

  // axes
  svg.append('g')
    .attr('transform', `translate(0,${height - margin.bottom})`)
    .call(d3.axisBottom(x))
    .selectAll('text')
    .attr('transform','rotate(-32)')
    .style('text-anchor','end');

  svg.append('g')
    .attr('transform', `translate(${margin.left},0)`) 
    .call(d3.axisLeft(y))
    .append('text')
    .attr('x', -margin.left + 8)
    .attr('y', margin.top - 8)
    .attr('fill', '#e5e7eb')
    .attr('font-size', 12)
    .text('Rolling total (lb)');
}

function drawSpark(exDiv){
  const host = d3.select(exDiv).select('.spark');
  host.selectAll('*').remove();
  const rows = exDiv.querySelectorAll('tbody tr');
  if(!rows.length) return;
  const pts=[]; let cum=0;
  rows.forEach(tr=>{
    const wEl = tr.querySelector('.wlb');
    const rEl = tr.querySelector('.r');
    const w = wEl ? parseFloat(wEl.value) || 0 : 0;
    const r = rEl ? Math.max(1, parseInt(rEl.value) || 0) : 1;
    cum += w*r;
    pts.push(cum);
  });
  const w = 240, h = 60, m = {top:4,right:6,bottom:4,left:6};
  const svg = host.append('svg').attr('width', w).attr('height', h);
  const x = d3.scaleLinear().domain([1, pts.length]).range([m.left, w - m.right]);
  const y = d3.scaleLinear().domain([0, d3.max(pts)]).nice().range([h - m.bottom, m.top]);
  const line = d3.line().x((d,i)=>x(i+1)).y(d=>y(d)).curve(d3.curveMonotoneX);
  svg.append('path').attr('fill','none').attr('stroke','#34d399').attr('stroke-width',2).attr('d', line(pts));
}

// ================= CSV/XLSX Save/Load =================
const saveBtn = document.getElementById('saveCsv');
const loadBtn = document.getElementById('loadCsv');
const loadInput = document.getElementById('loadFileInput');
const loadModal = document.getElementById('loadModal');
const importHereBtn = document.getElementById('importHereBtn');
const openSheetsBtn = document.getElementById('openSheetsBtn');
const cancelLoadBtn = document.getElementById('cancelLoadBtn');
let pendingCsvFile = null; // File object
let pendingCsvText = '';

function csvEscape(val){
  const s = String(val ?? '');
  if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function planToAOA(){
  const rows = [[
    'Date','Exercise','Set','Weight_lb','Weight_kg','Reps','Epley_1RM','Brzycki_1RM','Lander_1RM','Set_Volume_lb','Exercise_Total_Volume_lb','Workout_Rolling_lb'
  ]];
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const date = `${yyyy}-${mm}-${dd}`;
  let workoutRolling = 0;
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const name = exDiv.querySelector('h2')?.textContent.trim() || '';
    let exerciseTotal = 0;
    exDiv.querySelectorAll('tbody tr').forEach((tr, i) => {
      const wlb = parseFloat(tr.querySelector('.wlb')?.value) || 0;
      const wkg = toKg(wlb);
      const reps = Math.max(1, parseInt(tr.querySelector('.r')?.value) || 0);
      const e = epley(wlb, reps);
      const b = brzycki(wlb, reps);
      const l = lander(wlb, reps);
      const setVol = wlb * reps;
      exerciseTotal += setVol;
      workoutRolling += setVol;
      rows.push([
        date, name, i+1,
        Number(wlb.toFixed(1)), Number(wkg.toFixed(1)), reps,
        Number(e.toFixed(1)), Number(b.toFixed(1)), Number(l.toFixed(1)),
        Number(setVol.toFixed(1)), Number(exerciseTotal.toFixed(1)), Number(workoutRolling.toFixed(1))
      ]);
    });
  });
  return { rows, filename: `workout_${date}.xlsx` };
}

function buildXlsxFromPlan(){
  const { rows, filename } = planToAOA();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Workout');
  const buf = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const file = new File([buf], filename, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  return { file };
}

function buildCsv(){
  const header = 'Date,Exercise,Set,Weight_lb,Weight_kg,Reps,Epley_1RM,Brzycki_1RM,Lander_1RM,Set_Volume_lb,Exercise_Total_Volume_lb,Workout_Rolling_lb';
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  const date = `${yyyy}-${mm}-${dd}`;
  let workoutRolling = 0;
  const lines = [header];
  exercisesDiv.querySelectorAll('.exercise').forEach(exDiv => {
    const name = exDiv.querySelector('h2')?.textContent.trim() || '';
    let exerciseTotal = 0;
    exDiv.querySelectorAll('tbody tr').forEach((tr, i) => {
      const wlb = parseFloat(tr.querySelector('.wlb')?.value) || 0;
      const wkg = toKg(wlb);
      const reps = Math.max(1, parseInt(tr.querySelector('.r')?.value) || 0);
      const e = epley(wlb, reps);
      const b = brzycki(wlb, reps);
      const l = lander(wlb, reps);
      const setVol = wlb * reps;
      exerciseTotal += setVol;
      workoutRolling += setVol;
      const row = [
        date,
        csvEscape(name),
        i+1,
        wlb.toFixed(1),
        wkg.toFixed(1),
        reps,
        e.toFixed(1),
        b.toFixed(1),
        l.toFixed(1),
        setVol.toFixed(1),
        exerciseTotal.toFixed(1),
        workoutRolling.toFixed(1)
      ].join(',');
      lines.push(row);
    });
  });
  const csv = lines.join('\r\n');
  const filename = `workout_${date}.csv`;
  return { csv, filename };
}

function downloadBlob(filename, blob){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

function downloadCsv(filename, csvOrBlob){
  const blob = csvOrBlob instanceof Blob ? csvOrBlob : new Blob([csvOrBlob], { type: 'text/csv;charset=utf-8;' });
  downloadBlob(filename, blob);
}

async function shareCsv(filename, csvText){
  try {
    const file = new File([csvText], filename, { type: 'text/csv' });
    if (navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files: [file], title: 'Workout CSV', text: 'Exported from Workout Planner' });
      return true;
    }
  } catch(e) { /* fall through to download */ }
  downloadCsv(filename, csvText);
  return false;
}

function norm(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,'_'); }
function splitCSV(line){
  const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
    const ch=line[i];
    if (ch === '"') { if (inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
    else if (ch === ',' && !inQ){ out.push(cur); cur=''; }
    else { cur+=ch; }
  }
  out.push(cur); return out;
}

function parseCsv(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  if (!lines.length) return [];
  const head = splitCSV(lines[0]).map(norm);
  const idx = (name) => head.indexOf(name);
  const iExercise = idx('exercise');
  const iSet = idx('set');
  let iWlb = idx('weight_lb'); if (iWlb<0) iWlb = head.findIndex(h=>/weight.*lb/.test(h));
  let iWkg = idx('weight_kg'); if (iWkg<0) iWkg = head.findIndex(h=>/weight.*kg/.test(h));
  const iReps = idx('reps');
  const planMap = new Map(); // name -> [{w,r,set}]

  for (let li=1; li<lines.length; li++){
    const cols = splitCSV(lines[li]);
    if (!cols.length) continue;
    const name = (cols[iExercise]||'').replace(/^"|"$/g,'');
    const setNo = parseInt(cols[iSet]||'0') || 1;
    let wlb = parseFloat(cols[iWlb]||'');
    const wkg = parseFloat(cols[iWkg]||'');
    if (!Number.isFinite(wlb) && Number.isFinite(wkg)) wlb = toLb(wkg);
    const reps = Math.max(1, parseInt(cols[iReps]||'0')||0);
    if (!planMap.has(name)) planMap.set(name, []);
    planMap.get(name).push({ set:setNo, w: wlb||0, r: reps||1 });
  }
  const plan=[];
  for (const [name, arr] of planMap.entries()){
    arr.sort((a,b)=>a.set-b.set);
    plan.push({ name, sets: arr.map(({w,r})=>({w,r})) });
  }
  return plan;
}

function showModal(){ loadModal.classList.add('show'); }
function hideModal(){ loadModal.classList.remove('show'); pendingCsvFile=null; pendingCsvText=''; }

// Save/Load events
saveBtn.addEventListener('click', async () => {
  const { csv, filename } = buildCsv();
  await shareCsv(filename, csv); // fallback downloads if share unsupported
});

loadBtn.addEventListener('click', () => { loadInput && loadInput.click(); });

loadInput.addEventListener('change', async (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  pendingCsvFile = file;
  try {
    if (/\.xlsx$/i.test(file.name) || /sheet/.test(file.type)) {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const first = wb.SheetNames[0];
      pendingCsvText = XLSX.utils.sheet_to_csv(wb.Sheets[first]);
    } else {
      pendingCsvText = await file.text();
    }
  } catch(err){
    try { pendingCsvText = await file.text(); } catch(_) { pendingCsvText = ''; }
  }
  showModal();
});

cancelLoadBtn.addEventListener('click', hideModal);

importHereBtn.addEventListener('click', () => {
  try { const plan = parseCsv(pendingCsvText); writePlan(plan); } catch(e) { alert('Could not import file'); }
  hideModal();
});

openSheetsBtn.addEventListener('click', async () => {
  try {
    // Prefer XLSX when opening in Google Sheets on iOS
    let fileName = 'workout.xlsx';
    let file;
    if (pendingCsvText) {
      try {
        const wbFromCsv = XLSX.read(pendingCsvText, { type: 'string' });
        const xbuf = XLSX.write(wbFromCsv, { bookType: 'xlsx', type: 'array' });
        file = new File([xbuf], fileName, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      } catch(e) {
        const built = buildXlsxFromPlan();
        file = built.file; fileName = built.file.name || fileName;
      }
    } else {
      const built = buildXlsxFromPlan();
      file = built.file; fileName = built.file.name || fileName;
    }

    if (navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files: [file], title: 'Open in Google Sheets' });
    } else {
      downloadBlob(fileName, file);
      alert('Sharing not supported here. XLSX downloaded â€” open it with the Google Sheets app.');
    }
  } catch(e) {
    const built = buildXlsxFromPlan();
    downloadBlob(built.file.name, built.file);
  }
  hideModal();
});

// ================= Diagnostics (tests) =================
(function selfTest(){
  try {
    const almostEq = (a,b,eps=1e-6) => Math.abs(a-b) < eps;
    // unit conversions
    console.assert(almostEq(toLb(100*KG_PER_LB), 100), 'toLb âˆ˜ toKg roundtrip failed');
    console.assert(almostEq(toKg(100*LB_PER_KG), 100), 'toKg âˆ˜ toLb roundtrip failed');
    // formulas (225x10)
    const w=225, r=10;
    console.assert(almostEq(epley(w,r), 300), 'Epley check failed');
    console.assert(almostEq(brzycki(w,r), 300), 'Brzycki check failed');
    const l = lander(w,r); console.assert(l > 301 && l < 302.5, 'Lander range failed');
    // CSV header & builder
    const built = buildCsv();
    console.assert(built.csv.startsWith('Date,Exercise,Set'), 'CSV header check failed');
    // splitCSV edge cases
    const row = '"Incline, DB",2,100,45,8';
    const cols = splitCSV(row);
    console.assert(cols[0] === '"Incline, DB"', 'splitCSV quoted comma failed');
    const row2 = '"He said ""go""",1,95,43,5';
    const cols2 = splitCSV(row2);
    console.assert(cols2[0] === '"He said ""go"""', 'splitCSV double quotes failed');
    document.getElementById('diag').textContent = 'Diagnostics passed';
  } catch(e) {
    const d = document.getElementById('diag');
    d.style.display='block';
    d.textContent = 'Diagnostics error: ' + e.message;
  }
})();

// seed example
addExercise('Bench Press');

</script>
</body>
</html>




