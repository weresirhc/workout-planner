<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Workout Planner — Sets & 1RM</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --bg:#0f172a; --surface:#1e293b; --surface-2:#111827; --line:#334155; --text:#e5e7eb; --muted:#94a3b8; }
    *{box-sizing:border-box}
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); margin: 0; padding: 16px 16px 80px; }
    h1{ font-size: 1.8em; margin: 0 0 8px; }
    .muted{ color:var(--muted); }
    .stack{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn-sm{ padding: 10px 12px; border-radius: 10px; font-size: 14px; min-width: 44px; min-height: 44px; border:1px solid var(--line); background: var(--surface-2); color: var(--text); }
    .exercise{ margin-top: 16px; border: 1px solid var(--line); border-radius: 12px; padding: 12px; background: var(--surface); }
    .exercise h2{ margin: 0 0 8px; font-size: 1.2em; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .title{ outline:none; }
    .drag-handle{ cursor: grab; user-select: none; font-size: 20px; padding: 6px 10px; border-radius: 10px; background:var(--surface-2); border:1px solid var(--line); }
    .drag-handle:active{ cursor: grabbing; }

    .table-wrap{ overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table{ width: 100%; border-collapse: separate; border-spacing: 0; margin: 8px 0; min-width: 700px; }
    th, td{ padding: 10px; border-bottom: 1px solid var(--line); position: relative; }
    th{ text-align: left; background: var(--surface-2); color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:.02em; position: sticky; top: 0; z-index: 5; box-shadow: 0 1px 0 var(--line), 0 2px 8px rgba(0,0,0,.18); }

    /* Weight column with stacked lb / kg inputs */
    .wtcol{ display:flex; flex-direction:column; gap:6px; min-width: 150px; }
    .wtcol .row{ display:flex; align-items:center; gap:8px; }
    .wtcol .unit{ color:var(--muted); font-size:12px; width:28px; text-transform:uppercase; letter-spacing:.04em; }

    /* Numeric control only used for REPS now */
    .numctl{ display:flex; align-items:center; gap:6px; }
    .numctl input{ width: 84px; height: 44px; padding: 6px 8px; background: var(--surface-2); border: 1px solid var(--line); color: var(--text); border-radius: 10px; font-size:16px; }
    .numctl button{ width: 44px; height: 44px; border-radius: 12px; border: 1px solid var(--line); background: var(--surface-2); color: var(--text); font-size:20px; font-weight:700; }

    .quickchips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
    .chip{ padding:8px 10px; border-radius:9999px; border:1px solid var(--line); background:var(--surface-2); font-size:12px; }

    .actions{ white-space: nowrap; }
    .dragging{ opacity: .6; }

    /* Compact/hidden modes */
    body.hide-1rm .exercise td.epley,
    body.hide-1rm .exercise td.brzycki,
    body.hide-1rm .exercise td.lander,
    body.hide-1rm .exercise th.th-epley,
    body.hide-1rm .exercise th.th-brzycki,
    body.hide-1rm .exercise th.th-lander{ display:none }
    body.hide-1rm .exercise table{ min-width: 500px; }
    body.hide-incr .numctl button{ display:none }
    body.hide-incr .quickchips{ display:none }

    /* Bottom toolbar */
    .thumbbar{ position: fixed; left: 0; right: 0; bottom: 0; background: rgba(17,24,39,.92); border-top: 1px solid var(--line); padding: 8px 12px calc(12px + env(safe-area-inset-bottom,0)); display:flex; justify-content:center; gap:8px; z-index:60; backdrop-filter: blur(8px); }
    .thumbbar .row{ display:flex; gap:8px; }

    /* Mobile tweaks */
    @media (max-width: 600px){
      table{ font-size: 13px; min-width: 520px; }
      th, td{ padding: 6px 4px; }
      .wtcol{ min-width: 120px; gap:4px }
      .wtcol .row input{ height: 36px; }
      .numctl input{ width:72px; height:38px; font-size:15px }
      .numctl button{ width:34px; height:34px; font-size:18px }
      .btn-sm{ padding:8px 10px; min-width:38px; min-height:38px; font-size:13px }
    }
  </style>
</head>
<body>
  <h1>Workout Planner</h1>
  <div class="stack" style="margin:8px 0 12px">
    <button id="addExercise" class="btn-sm">+ Add exercise</button>
    <button id="undoBtn" class="btn-sm">Undo last</button>
    <button id="toggle1rm" class="btn-sm">Hide 1RM</button>
    <button id="toggleIncr" class="btn-sm">Hide Increments</button>
    <button id="saveCsv" class="btn-sm">Save CSV</button>
    <button id="loadCsv" class="btn-sm">Load CSV/XLSX</button>
  </div>

  <div id="exercises"></div>

  <input id="loadFileInput" type="file" accept=".csv,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx" style="display:none" />
  <div id="loadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="loadTitle">
    <div class="panel">
      <h3 id="loadTitle">Open File</h3>
      <p>Choose where to open your saved data.</p>
      <div class="actions-row">
        <button id="importHereBtn" class="btn-sm">Import here</button>
        <button id="openSheetsBtn" class="btn-sm">Open in Google Sheets</button>
        <button id="cancelLoadBtn" class="btn-sm">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Bottom toolbar -->
  <div class="thumbbar">
    <div class="row">
      <button id="tbAddSet" class="btn-sm">+ Set</button>
      <button id="tbAddExercise" class="btn-sm">+ Exercise</button>
      <button id="tbSave" class="btn-sm">Save</button>
    </div>
  </div>

<script>
// ===== Helpers =====
var LB_PER_KG=2.2046226218, KG_PER_LB=1/LB_PER_KG;
function toKg(lb){ return lb*KG_PER_LB }
function toLb(kg){ return kg*LB_PER_KG }
function epley(w,r){ return w*(1+r/30) }
function brzycki(w,r){ return w*(36/(37-r)) }
function lander(w,r){ return w/(1.013-0.0267123*r) }
function haptic(p){ try{ if(navigator.vibrate) navigator.vibrate(p||10) }catch(e){} }
function $(s){ return document.querySelector(s) }
function $all(s,root){ return Array.prototype.slice.call((root||document).querySelectorAll(s)) }
function S(k,v){ try{ localStorage.setItem(k,v) }catch(e){} }
function G(k){ try{ return localStorage.getItem(k) }catch(e){ return null } }
function textContentTrim(el){ var t=el && el.textContent; return (t ? String(t) : '').trim() }

// ===== State =====
var exercisesDiv=$('#exercises');
var undoStack=[]; var isRestoring=false;

// ===== Plan read/write =====
function readPlan(){
  var plan=[];
  $all('.exercise').forEach(function(ex){
    var nameEl=ex.querySelector('.title') || ex.querySelector('h2');
    var name=textContentTrim(nameEl);
    var sets=[];
    $all('tbody tr',ex).forEach(function(tr){
      var wEl=tr.querySelector('.wlb');
      var rEl=tr.querySelector('.r');
      var w=parseInt(wEl && wEl.value,10); if(!isFinite(w)) w=0;
      var r=parseInt(rEl && rEl.value,10); if(!isFinite(r)||r<1) r=1;
      sets.push({w:w,r:r});
    });
    plan.push({name:name,sets:sets});
  });
  return plan;
}
function writePlan(plan){
  isRestoring=true; exercisesDiv.innerHTML='';
  (plan||[]).forEach(function(ex){
    addExercise(ex.name||'Exercise');
    var el=exercisesDiv.lastElementChild, tbody=el.querySelector('tbody');
    tbody.innerHTML='';
    (ex.sets||[]).forEach(function(s){ addSet(tbody,s.w,s.r) });
  });
  isRestoring=false; update();
}
function pushHistory(){ if(isRestoring) return; try{ undoStack.push(JSON.stringify(readPlan())); if(undoStack.length>50) undoStack.shift(); }catch(e){} }
function undoLast(){ if(!undoStack.length) return; try{ writePlan(JSON.parse(undoStack.pop())) }catch(e){} }

// ===== Drag helpers =====
function makeExerciseDraggable(ex){
  ex.setAttribute('draggable','true');
  ex.addEventListener('dragstart',function(e){ e.dataTransfer.effectAllowed='move'; ex.classList.add('dragging'); });
  ex.addEventListener('dragend',function(){ ex.classList.remove('dragging') });
}
function getAfter(container,y,sel){
  return $all(sel,container).reduce(function(c,ch){
    var b=ch.getBoundingClientRect(), o=y-b.top-b.height/2;
    return (o<0 && o>c.offset) ? {offset:o, element:ch} : c;
  }, {offset:-Infinity}).element;
}
function setupExerciseDropZone(){
  exercisesDiv.addEventListener('dragover',function(e){ var d=$('.exercise.dragging'); if(!d) return; e.preventDefault(); var after=getAfter(exercisesDiv,e.clientY,'.exercise:not(.dragging)'); after?exercisesDiv.insertBefore(d,after):exercisesDiv.appendChild(d) });
  exercisesDiv.addEventListener('drop',function(){ pushHistory(); update(); haptic([5,30,5]) });
}
function makeRowDraggable(tr){ tr.setAttribute('draggable','true'); tr.addEventListener('dragstart',function(){ tr.classList.add('dragging') }); tr.addEventListener('dragend',function(){ tr.classList.remove('dragging') }); }
function setupSetDropZone(tbody){
  tbody.addEventListener('dragover',function(e){ var d=tbody.querySelector('tr.dragging'); if(!d) return; e.preventDefault(); var after=getAfter(tbody,e.clientY,'tr:not(.dragging)'); after?tbody.insertBefore(d,after):tbody.appendChild(d) });
  tbody.addEventListener('drop',function(){ pushHistory(); update(); haptic([5,30,5]) });
}

// ===== UI builders =====
function addExercise(name){
  if(name==null) name='New Exercise';
  pushHistory();
  var ex=document.createElement('div'); ex.className='exercise';
  ex.innerHTML='\
    <h2>\
      <span class="title" contenteditable="true" tabindex="0">'+name+'</span>\
      <span style="display:flex; gap:6px; align-items:center;">\
        <button class="collapse btn-sm" title="Collapse">▾</button>\
        <button class="drag-handle" title="Drag">☰</button>\
      </span>\
    </h2>\
    <div class="table-wrap"><table>\
      <thead><tr>\
        <th data-short="Set">Set</th>\
        <th data-short="Wt">Weight</th>\
        <th data-short="Reps">Reps</th>\
        <th class="th-epley" data-short="Epl">Epley 1RM</th>\
        <th class="th-brzycki" data-short="Brz">Brzycki 1RM</th>\
        <th class="th-lander" data-short="Lnd">Lander 1RM</th>\
        <th data-short="Act">Actions</th>\
      </tr></thead>\
      <tbody></tbody>\
    </table></div>\
    <div class="quickchips"><span class="muted">Quick add lb:</span>\
      <button class="chip add5" type="button">+5</button>\
      <button class="chip add10" type="button">+10</button>\
      <button class="chip add25" type="button">+25</button>\
    </div>\
    <div class="stack" style="margin-top:8px">\
      <button class="addSet btn-sm" type="button">Add Set</button>\
      <button class="removeEx btn-sm" type="button">Delete Exercise</button>\
    </div>';
  exercisesDiv.appendChild(ex);

  makeExerciseDraggable(ex);
  var handle=ex.querySelector('.drag-handle');
  handle.addEventListener('mousedown',function(){ ex.draggable=true });
  handle.addEventListener('touchstart',function(){ ex.draggable=true },{passive:true});

  var collapseBtn=ex.querySelector('.collapse');
  collapseBtn.addEventListener('click',function(){ ex.classList.toggle('collapsed'); collapseBtn.textContent=ex.classList.contains('collapsed')?'▸':'▾' });

  [[".add5",5],[".add10",10],[".add25",25]].forEach(function(pair){
    var sel=pair[0], delta=pair[1];
    ex.querySelector(sel).addEventListener('click',function(){
      var row=ex.querySelector('tbody tr:last-of-type'); if(!row) return;
      var lb=row.querySelector('.wlb');
      var v=parseInt(lb && lb.value,10); if(!isFinite(v)) v=0; v+=delta; lb.value=v;
      var k=row.querySelector('.wkg'); if(k) k.value=Math.round(toKg(v));
      update(); haptic(10);
    });
  });

  var title=ex.querySelector('.title');
  ex.scrollIntoView({behavior:'smooth',block:'start'}); title.focus();
  try{ var sel=getSelection(), rng=document.createRange(); rng.selectNodeContents(title); sel.removeAllRanges(); sel.addRange(rng); }catch(e){}

  var tbody=ex.querySelector('tbody');
  setupSetDropZone(tbody);
  ex.querySelector('.addSet').addEventListener('click',function(){ addSet(tbody); haptic(10) });
  ex.querySelector('.removeEx').addEventListener('click',function(){ pushHistory(); ex.remove(); update(); haptic([10,20,10]) });
  addSet(tbody);
}

function addSet(tbody,w,r){
  if(!isFinite(w)) w=0; if(!isFinite(r)) r=1;
  var tr=document.createElement('tr'); var n=tbody.children.length+1; pushHistory();
  tr.innerHTML='\
    <td class="setno">'+n+'<\/td>\
    <td>\
      <div class="wtcol">\
        <div class="row"><span class="unit">lb<\/span>\
          <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" value="'+parseInt(w,10)+'" class="wlb">\
        <\/div>\
        <div class="row"><span class="unit">kg<\/span>\
          <input type="number" step="1" inputmode="numeric" pattern="[0-9]*" value="'+Math.round(toKg(w))+'" class="wkg">\
        <\/div>\
      <\/div>\
    <\/td>\
    <td>\
      <div class="numctl">\
        <button class="minus rm" type="button">−<\/button>\
        <input type="number" step="1" min="1" inputmode="numeric" pattern="[0-9]*" value="'+parseInt(r,10)+'" class="r">\
        <button class="plus rp" type="button">+<\/button>\
      <\/div>\
    <\/td>\
    <td class="epley"><\/td>\
    <td class="brzycki"><\/td>\
    <td class="lander"><\/td>\
    <td class="actions"><button class="btn-sm dup" type="button">+ Set<\/button><button class="btn-sm del" type="button">🗑<\/button><\/td>';
  tbody.appendChild(tr);

  makeRowDraggable(tr);

  $all('input',tr).forEach(function(inp){
    inp.addEventListener('input',function(){
      var v=parseInt(inp.value,10); if(!isFinite(v)) v=0; inp.value=v;
      var lb=tr.querySelector('.wlb'), kg=tr.querySelector('.wkg');
      if(inp===lb) kg.value=Math.round(toKg(v));
      if(inp===kg) lb.value=Math.round(toLb(v));
      update();
    });
    inp.addEventListener('focus',function onf(){ pushHistory(); inp.removeEventListener('focus',onf) });
  });

  var reps=tr.querySelector('.r');
  var rp=tr.querySelector('.rp'), rm=tr.querySelector('.rm');
  function repeat(btn,fn){ if(!btn) return; var t,a=false; function start(e){e.preventDefault(); if(a) return; a=true; fn(); haptic(5); t=setInterval(fn,120)} function stop(){a=false; clearInterval(t)} btn.addEventListener('mousedown',start); btn.addEventListener('touchstart',start,{passive:false}); ['mouseup','mouseleave','touchend','touchcancel'].forEach(function(ev){ btn.addEventListener(ev,stop) }) }
  repeat(rm,function(){ var v=parseInt(reps.value,10); if(!isFinite(v)) v=1; v=Math.max(1,v-1); reps.value=v; update() });
  repeat(rp,function(){ var v=parseInt(reps.value,10); if(!isFinite(v)) v=1; reps.value=v+1; update() });

  var dupBtn=tr.querySelector('.dup'); if(dupBtn) dupBtn.addEventListener('click',function(){ pushHistory(); var w=parseInt((tr.querySelector('.wlb')||{}).value,10); if(!isFinite(w)) w=0; var r=parseInt(reps.value,10); if(!isFinite(r)) r=1; addSet(tbody,w,r); var nr=tbody.lastElementChild; if(nr) tbody.insertBefore(nr,tr.nextElementSibling); update(); haptic(10) });
  var delBtn=tr.querySelector('.del'); if(delBtn) delBtn.addEventListener('click',function(){ pushHistory(); tr.remove(); update(); haptic([10,20,10]) });

  update();
}

// ===== Update (1RM only) =====
function update(){
  $all('.exercise').forEach(function(ex){
    $all('tbody tr',ex).forEach(function(tr,i){
      var setNo=tr.querySelector('.setno'); if(setNo && setNo.childNodes[0]) setNo.childNodes[0].nodeValue=(i+1)+' ';
      var w=parseInt((tr.querySelector('.wlb')||{}).value,10); if(!isFinite(w)) w=0;
      var r=parseInt((tr.querySelector('.r')||{}).value,10); if(!isFinite(r)||r<1) r=1;
      var e=epley(w,r), b=brzycki(w,r), l=lander(w,r);
      var eEl=tr.querySelector('.epley'), bEl=tr.querySelector('.brzycki'), lEl=tr.querySelector('.lander');
      if(eEl) eEl.textContent=e?e.toFixed(1):'';
      if(bEl) bEl.textContent=b?b.toFixed(1):'';
      if(lEl) lEl.textContent=l?l.toFixed(1):'';
    });
  });
  try{ S('planV1', JSON.stringify(readPlan())) }catch(e){}
}

// ===== CSV/XLSX helpers =====
function csvEscape(v){ var s=String(v==null?'':v); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s }
function splitCSV(line){ var out=[], cur='', q=false; for(var i=0;i<line.length;i++){ var c=line[i]; if(c=='"'){ if(q && line[i+1]=='"'){ cur+='"'; i++; } else q=!q; } else if(c==',' && !q){ out.push(cur); cur=''; } else cur+=c; } out.push(cur); return out }
function parseCsv(t){
  var lines=t.split(/\r?\n/).filter(function(l){return l.trim().length}); if(!lines.length) return [];
  var head=splitCSV(lines[0]).map(function(s){ return String(s==null?'':s).trim().toLowerCase().replace(/\s+/g,'_') });
  function idx(n){ return head.indexOf(n) }
  var iE=idx('exercise'), iS=idx('set');
  var iLb=idx('weight_lb'); if(iLb<0) iLb=head.findIndex(function(h){return /weight.*lb/.test(h)});
  var iKg=idx('weight_kg'); if(iKg<0) iKg=head.findIndex(function(h){return /weight.*kg/.test(h)});
  var iR=idx('reps');
  var map=new Map();
  for(var li=1; li<lines.length; li++){
    var cols=splitCSV(lines[li]); if(!cols.length) continue;
    var name=(cols[iE]||'').replace(/^\"|\"$/g,'');
    var setNo=parseInt(cols[iS]||'0',10)||1;
    var wlb=parseInt(cols[iLb]||'',10); var wkg=parseInt(cols[iKg]||'',10);
    if(!isFinite(wlb) && isFinite(wkg)) wlb=Math.round(toLb(wkg));
    var reps=parseInt(cols[iR]||'0',10); if(!isFinite(reps)||reps<1) reps=1;
    if(!map.has(name)) map.set(name,[]);
    map.get(name).push({set:setNo,w:wlb||0,r:reps||1});
  }
  var plan=[]; map.forEach(function(arr,name){ arr.sort(function(a,b){return a.set-b.set}); plan.push({name:name,sets:arr.map(function(x){return {w:x.w,r:x.r}})}) });
  return plan;
}

function planToAOA(){
  var rows=[["Date","Exercise","Set","Weight_lb","Weight_kg","Reps","Epley_1RM","Brzycki_1RM","Lander_1RM"]];
  var d=new Date(); var date=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
  $all('.exercise').forEach(function(ex){
    var name=textContentTrim(ex.querySelector('.title')||ex.querySelector('h2'));
    $all('tbody tr',ex).forEach(function(tr,i){
      var wlb=parseInt((tr.querySelector('.wlb')||{}).value,10); if(!isFinite(wlb)) wlb=0;
      var wkg=Math.round(toKg(wlb));
      var reps=parseInt((tr.querySelector('.r')||{}).value,10); if(!isFinite(reps)||reps<1) reps=1;
      var e=epley(wlb,reps), b=brzycki(wlb,reps), l=lander(wlb,reps);
      rows.push([ date, name, i+1, wlb, wkg, reps, Number(e.toFixed(1)), Number(b.toFixed(1)), Number(l.toFixed(1)) ]);
    });
  });
  return { rows:rows, filename:'workout_'+date+'.xlsx' };
}
function buildXlsxFromPlan(){ var out=planToAOA(); var ws=XLSX.utils.aoa_to_sheet(out.rows), wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Workout'); var buf=XLSX.write(wb,{bookType:'xlsx',type:'array'}); return { file:new File([buf], out.filename, {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}) } }
function buildCsv(){
  var hdr='Date,Exercise,Set,Weight_lb,Weight_kg,Reps,Epley_1RM,Brzycki_1RM,Lander_1RM';
  var d=new Date(); var date=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0')+"-"+String(d.getDate()).padStart(2,'0');
  var lines=[hdr];
  $all('.exercise').forEach(function(ex){
    var name=textContentTrim(ex.querySelector('.title')||ex.querySelector('h2'));
    $all('tbody tr',ex).forEach(function(tr,i){
      var wlb=parseInt((tr.querySelector('.wlb')||{}).value,10); if(!isFinite(wlb)) wlb=0;
      var wkg=Math.round(toKg(wlb));
      var reps=parseInt((tr.querySelector('.r')||{}).value,10); if(!isFinite(reps)||reps<1) reps=1;
      var e=epley(wlb,reps), b=brzycki(wlb,reps), l=lander(wlb,reps);
      lines.push([ date, csvEscape(name), i+1, wlb, wkg, reps, e.toFixed(1), b.toFixed(1), l.toFixed(1) ].join(','));
    });
  });
  return { csv:lines.join('\r\n'), filename:'workout_'+date+'.csv' };
}

// ===== DOM refs & wiring =====
var addExBtn=$('#addExercise'), undoBtn=$('#undoBtn'), t1=$('#toggle1rm'), tInc=$('#toggleIncr');
var saveBtn=$('#saveCsv'), loadBtn=$('#loadCsv'), loadInput=$('#loadFileInput'), loadModal=$('#loadModal'), importHereBtn=$('#importHereBtn'), openSheetsBtn=$('#openSheetsBtn'), cancelLoadBtn=$('#cancelLoadBtn');
var tbAddSet=$('#tbAddSet'), tbAddExercise=$('#tbAddExercise'), tbSave=$('#tbSave');

var pendingCsvText='';
function downloadBlob(name,blob){ var u=URL.createObjectURL(blob), a=document.createElement('a'); a.href=u; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(u)},2000) }
function downloadCsv(name,csvOrBlob){ downloadBlob(name, csvOrBlob instanceof Blob?csvOrBlob:new Blob([csvOrBlob],{type:'text/csv;charset=utf-8;'}) ) }
function shareCsv(name,text){
  return (async function(){
    try{ var f=new File([text],name,{type:'text/csv'}); if(navigator.canShare && navigator.canShare({files:[f]})){ await navigator.share({files:[f],title:'Workout CSV',text:'Exported from Workout Planner'}); haptic([5,30,5]); return true } }
    catch(e){}
    downloadCsv(name,text); return false;
  })();
}
function showModal(){ if(loadModal) loadModal.classList.add('show') }
function hideModal(){ if(loadModal) loadModal.classList.remove('show'); pendingCsvText='' }

if(saveBtn) saveBtn.addEventListener('click',function(){ var out=buildCsv(); shareCsv(out.filename,out.csv) });
if(loadBtn) loadBtn.addEventListener('click',function(){ if(loadInput) loadInput.click() });
if(loadInput) loadInput.addEventListener('change',function(e){
  var f=e.target.files && e.target.files[0]; if(!f) return;
  (async function(){ try{ if(/\.xlsx$/i.test(f.name) || /sheet/.test(f.type)){ var buf=await f.arrayBuffer(); var wb=XLSX.read(buf,{type:'array'}); pendingCsvText=XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]) } else { pendingCsvText=await f.text() } } catch(err){ try{ pendingCsvText=await f.text() }catch(e){ pendingCsvText='' } } showModal() })();
});
if(cancelLoadBtn) cancelLoadBtn.addEventListener('click',hideModal);
if(importHereBtn) importHereBtn.addEventListener('click',function(){ try{ writePlan(parseCsv(pendingCsvText)); haptic([5,30,5]) }catch(e){ alert('Could not import file') } hideModal() });
if(openSheetsBtn) openSheetsBtn.addEventListener('click',function(){ (async function(){ try{ var fileName='workout.xlsx', file; if(pendingCsvText){ try{ var wb=XLSX.read(pendingCsvText,{type:'string'}); var xbuf=XLSX.write(wb,{bookType:'xlsx',type:'array'}); file=new File([xbuf],fileName,{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}) }catch(e){ file=buildXlsxFromPlan().file } } else { file=buildXlsxFromPlan().file } if(navigator.canShare && navigator.canShare({files:[file]})){ await navigator.share({files:[file],title:'Open in Google Sheets'}); haptic([5,30,5]) } else { downloadBlob(fileName,file); alert('Sharing not supported here. XLSX downloaded — open it with the Google Sheets app.') } }catch(e){ var b=buildXlsxFromPlan(); downloadBlob(b.file.name,b.file) } hideModal() })() });

// Toggles
if(addExBtn) addExBtn.addEventListener('click',function(){ addExercise(); haptic(10) });
if(undoBtn) undoBtn.addEventListener('click',function(){ undoLast(); haptic(10) });
var hide1rm=(G('hide1RM')||((innerWidth<480)?'1':'0'))==='1', hideInc=(G('hideInc')||'0')==='1';
function applyHide1rm(){ document.body.classList.toggle('hide-1rm',hide1rm); var t=hide1rm?'Show 1RM':'Hide 1RM'; if(t1) t1.textContent=t }
function applyHideInc(){ document.body.classList.toggle('hide-incr',hideInc); var t=hideInc?'Show Increments':'Hide Increments'; if(tInc) tInc.textContent=t }
function toggleHide1rm(){ hide1rm=!hide1rm; S('hide1RM',hide1rm?'1':'0'); applyHide1rm() }
function toggleHideInc(){ hideInc=!hideInc; S('hideInc',hideInc?'1':'0'); applyHideInc() }
applyHide1rm(); applyHideInc();
if(t1) t1.addEventListener('click',toggleHide1rm);

if(tbAddSet) tbAddSet.addEventListener('click',function(){ var last=$('.exercise:last-of-type'); if(!last){ addExercise(); last=$('.exercise:last-of-type'); } var tb=last.querySelector('tbody'); addSet(tb); var row=tb && tb.lastElementChild; if(row && row.scrollIntoView) row.scrollIntoView({behavior:'smooth',block:'center'}) });
if(tbAddExercise) tbAddExercise.addEventListener('click',function(){ addExercise() });
if(tbSave) tbSave.addEventListener('click',function(){ var out=buildCsv(); shareCsv(out.filename,out.csv) });

// ===== Boot =====
(function boot(){ try{ var raw=G('planV1'); if(raw){ var plan=JSON.parse(raw); if(Array.isArray(plan) && plan.length){ writePlan(plan); return } } }catch(e){} addExercise('Bench Press') })();
setupExerciseDropZone();
</script>
</body>
</html>






